{% extends "layouts/base.njk" %}

{% block content %}
<div class="account-container max-w-4xl">
  <div class="account-header">
    <div class="flex items-center gap-4">
      <a href="/customer/messages" class="btn btn-secondary">Back to Inbox</a>
      <div>
        <h1 class="text-xl mb-0" id="ad-title">Loading...</h1>
        <p class="text-xs text-gray-500 font-bold uppercase" id="chat-partner"></p>
      </div>
    </div>
    <a href="#" id="view-ad-link" class="btn btn-sm btn-ghost">View Ad</a>
  </div>

  <div class="chat-wrapper bg-gray-50 rounded-2xl border-2 border-gray-100 flex flex-col h-[600px] overflow-hidden">
    <div id="messages-container" class="flex-1 overflow-y-auto p-6 space-y-4">
      <div class="text-center py-12 text-gray-400 italic">Starting conversation...</div>
    </div>

    <div class="p-4 bg-white border-t-2 border-gray-100">
      <form id="reply-form" class="space-y-3">
        <textarea 
          id="message-input"
          name="content" 
          required 
          rows="2" 
          placeholder="Type your message..." 
          class="w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-xl focus:border-primary-500 outline-none transition-all text-sm"
        ></textarea>
        
        <div class="flex gap-2">
          <input 
            type="url" 
            id="image-input"
            name="image" 
            placeholder="Image URL (optional)" 
            class="flex-1 p-2 bg-gray-50 border-2 border-gray-100 rounded-xl text-xs outline-none"
          >
          <button type="submit" id="send-btn" class="bg-primary-600 text-white px-8 rounded-xl font-black uppercase tracking-widest hover:bg-primary-700 transition-colors">
            Send
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const conversationId = {{ conversationId }};
  let currentUserId = null;

  async function loadMessages() {
    try {
      // Get current user ID first if we don't have it
      if (!currentUserId) {
        const userRes = await fetch('/api/customer-auth/me', { credentials: 'include' });
        const userData = await userRes.json();
        currentUserId = userData.id;
      }

      const response = await fetch(`/api/messages/conversations/${conversationId}`, { credentials: 'include' });
      if (!response.ok) throw new Error('Failed to load conversation');
      
      const { conversation, messages } = await response.json();
      
      document.getElementById('ad-title').textContent = conversation.ad.title;
      document.getElementById('view-ad-link').href = conversation.ad.slug;
      
      const isBuyer = currentUserId === conversation.buyer_id;
      const partner = isBuyer ? conversation.seller : conversation.buyer;
      document.getElementById('chat-partner').textContent = `Chatting with ${partner.first_name} ${partner.last_name}`;

      const container = document.getElementById('messages-container');
      const wasAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 100;

      container.innerHTML = messages.map(msg => {
        const isMe = msg.sender_id === currentUserId;
        return `
          <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
            <div class="max-w-[80%] ${isMe ? 'bg-primary-600 text-white rounded-l-2xl rounded-tr-2xl' : 'bg-white border-2 border-gray-100 text-gray-800 rounded-r-2xl rounded-tl-2xl'} p-4 shadow-sm">
              ${msg.image_url ? `<img src="${msg.image_url}" class="rounded-lg mb-2 max-h-60 w-full object-cover">` : ''}
              <p class="text-sm">${msg.content || ''}</p>
              <div class="flex items-center gap-2 mt-1 opacity-60 text-[9px] uppercase font-black">
                <span>${new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                ${isMe ? `<span>â€¢ ${msg.is_read ? 'Read' : 'Sent'}</span>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');

      if (wasAtBottom) {
        container.scrollTop = container.scrollHeight;
      }
    } catch (err) {
      console.error(err);
    }
  }

  document.getElementById('reply-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('send-btn');
    const content = document.getElementById('message-input').value;
    const image = document.getElementById('image-input').value;
    
    btn.disabled = true;
    
    try {
      const response = await fetch('/api/messages/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          conversation_id: conversationId,
          content,
          image
        })
      });
      
      if (response.ok) {
        document.getElementById('message-input').value = '';
        document.getElementById('image-input').value = '';
        await loadMessages();
      }
    } catch (err) {
      alert('Failed to send message');
    } finally {
      btn.disabled = false;
    }
  });

  // Initial load
  loadMessages();
  
  // Simple polling for new messages every 5 seconds
  setInterval(loadMessages, 5000);
</script>

<style>
  .chat-wrapper {
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
  }
  #messages-container::-webkit-scrollbar {
    width: 6px;
  }
  #messages-container::-webkit-scrollbar-thumb {
    background: #e5e7eb;
    border-radius: 3px;
  }
</style>
{% endblock %}
