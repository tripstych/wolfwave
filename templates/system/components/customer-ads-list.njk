{#
# System Component: Customer's Ads List
# This is a protected system component - do not modify
# Usage: {% include "system/components/customer-ads-list.njk" %}
# Parameters: show_create_button (boolean, default: true)
#}

<div class="customer-ads-container">
  {% if show_create_button %}
  <div class="ads-header">
    <a href="/customer/ads/create" class="btn btn-primary">Create New Ad</a>
  </div>
  {% endif %}

  <div id="ads-list" class="ads-grid">
    <div class="loading">Loading your ads...</div>
  </div>
</div>

<script>
  async function loadCustomerAds() {
    try {
      const response = await fetch('/api/classified-ads/my-ads', { credentials: 'include' });
      if (!response.ok) throw new Error('Failed to load ads');
      
      const ads = await response.json();
      const adsList = document.getElementById('ads-list');
      
      if (ads.length === 0) {
        adsList.innerHTML = `
          <div class="empty-state">
            <p>You haven't posted any classified ads yet.</p>
            <a href="/customer/ads/create" class="btn btn-primary mt-4">Post Your First Ad</a>
          </div>
        `;
        return;
      }

      adsList.innerHTML = ads.map(ad => `
        <div class="customer-ad-card ${ad.status}">
          <div class="ad-image">
            ${ad.images && ad.images.length > 0 
              ? `<img src="${ad.images[0]}" alt="${ad.title}">`
              : `<div class="no-image">No Image</div>`}
          </div>
          <div class="ad-info">
            <div class="ad-status-badge ${ad.status}">${ad.status.replace('_', ' ')}</div>
            <h3>${ad.title}</h3>
            
            {# Personal ad fields (no price!) #}
            ${ad.age ? `<p class="ad-age">${ad.age} years old</p>` : ''}
            ${ad.relationship_status ? `<p class="ad-relationship">${ad.relationship_status.replace('_', ' ')}</p>` : ''}
            
            <p class="ad-date">Posted on ${new Date(ad.created_at).toLocaleDateString()}</p>
          </div>
          <div class="ad-actions">
            <a href="/customer/ads/edit/${ad.id}" class="btn btn-sm btn-secondary">Edit</a>
            <button onclick="deleteCustomerAd(${ad.id})" class="btn btn-sm btn-danger">Delete</button>
          </div>
        </div>
      `).join('');
    } catch (err) {
      console.error(err);
      document.getElementById('ads-list').innerHTML = '<p class="error">Failed to load ads</p>';
    }
  }

  async function deleteCustomerAd(id) {
    if (!confirm('Are you sure you want to delete this ad?')) return;
    
    try {
      const response = await fetch(`/api/classified-ads/${id}`, {
        method: 'DELETE',
        credentials: 'include'
      });
      
      if (response.ok) {
        loadCustomerAds();
      } else {
        alert('Failed to delete ad');
      }
    } catch (err) {
      console.error(err);
      alert('Error deleting ad');
    }
  }

  // Load ads when DOM is ready
  if (document.getElementById('ads-list')) {
    document.addEventListener('DOMContentLoaded', loadCustomerAds);
  }
</script>