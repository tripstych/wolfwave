{% extends "layouts/base.njk" %}

{% block content %}
<div class="checkout-container">
  <h1>Checkout</h1>

  {% if canceled %}
    <div class="alert alert-warning">Checkout was canceled. You can try again below.</div>
  {% endif %}

  <div class="checkout-wrapper">
    {# Show login form only for guests #}
    {% if not customer %}
      {% include "partials/customer-login-form.njk" %}
    {% endif %}

    <form id="checkout-form" class="checkout-form">
      {# Step 1: Contact Information â€” only for guests #}
      {% if not customer %}
      <section class="checkout-step" data-step="1">
        <h2>Contact Information</h2>

        <div class="form-group">
          <label for="email">Email Address *</label>
          <input
            type="email"
            id="email"
            name="email"
            required
            placeholder="you@example.com"
          >
        </div>

        <button type="button" class="btn btn-primary" onclick="checkoutManager.goToStep(2)">
          Continue to Shipping
        </button>
      </section>
      {% endif %}

      {# Step 2: Shipping Address #}
      <section class="checkout-step{% if not customer %} hidden{% endif %}" data-step="2">
        <h2>Shipping Address</h2>

        <div class="form-row">
          <div class="form-group">
            <label for="first_name">First Name *</label>
            <input type="text" id="first_name" name="first_name" required
              value="{{ customer.default_address.first_name if customer and customer.default_address else (customer.first_name if customer else '') }}">
          </div>
          <div class="form-group">
            <label for="last_name">Last Name *</label>
            <input type="text" id="last_name" name="last_name" required
              value="{{ customer.default_address.last_name if customer and customer.default_address else (customer.last_name if customer else '') }}">
          </div>
        </div>

        <div class="form-group">
          <label for="address1">Address *</label>
          <input type="text" id="address1" name="address1" required placeholder="Street address"
            value="{{ customer.default_address.address1 if customer and customer.default_address else '' }}">
        </div>

        <div class="form-group">
          <label for="address2">Apartment, suite, etc. (optional)</label>
          <input type="text" id="address2" name="address2" placeholder="Apartment or suite"
            value="{{ customer.default_address.address2 if customer and customer.default_address else '' }}">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="city">City *</label>
            <input type="text" id="city" name="city" required
              value="{{ customer.default_address.city if customer and customer.default_address else '' }}">
          </div>
          <div class="form-group">
            <label for="province">State / Province *</label>
            <input type="text" id="province" name="province" required
              value="{{ customer.default_address.province if customer and customer.default_address else '' }}">
          </div>
          <div class="form-group">
            <label for="postal_code">Postal Code *</label>
            <input type="text" id="postal_code" name="postal_code" required
              value="{{ customer.default_address.postal_code if customer and customer.default_address else '' }}">
          </div>
        </div>

        <div class="form-group">
          <label for="country">Country *</label>
          <select id="country" name="country" required>
            <option value="">Select country</option>
            <option value="US"{{ ' selected' if (customer and customer.default_address and customer.default_address.country == 'US') or not customer }}>United States</option>
            <option value="CA"{{ ' selected' if customer and customer.default_address and customer.default_address.country == 'CA' }}>Canada</option>
            <option value="GB"{{ ' selected' if customer and customer.default_address and customer.default_address.country == 'GB' }}>United Kingdom</option>
            <option value="AU"{{ ' selected' if customer and customer.default_address and customer.default_address.country == 'AU' }}>Australia</option>
            <option value="DE"{{ ' selected' if customer and customer.default_address and customer.default_address.country == 'DE' }}>Germany</option>
            <option value="FR"{{ ' selected' if customer and customer.default_address and customer.default_address.country == 'FR' }}>France</option>
            <option value="JP"{{ ' selected' if customer and customer.default_address and customer.default_address.country == 'JP' }}>Japan</option>
          </select>
        </div>

        <div class="form-group">
          <label for="phone">Phone Number (optional)</label>
          <input type="tel" id="phone" name="phone" placeholder="+1 (555) 000-0000"
            value="{{ customer.default_address.phone if customer and customer.default_address else '' }}">
        </div>

        <div class="form-buttons">
          {% if not customer %}
          <button type="button" class="btn btn-secondary" onclick="checkoutManager.goToStep(1)">
            Back
          </button>
          {% endif %}
          <button type="button" id="place-order-btn" class="btn btn-primary" onclick="checkoutManager.proceedToPayment()">
            Proceed to Payment
          </button>
        </div>
      </section>
    </form>

    {# Order Summary Sidebar #}
    <aside class="order-summary">
      <h3>Order Summary</h3>
      <div id="summary-items" class="summary-items">
        <div class="loading">Loading cart...</div>
      </div>
      <div class="summary-totals">
        <div class="total-line">
          <span>Subtotal</span>
          <span id="summary-subtotal">$0.00</span>
        </div>
        <div class="total-line">
          <span>Shipping</span>
          <span id="summary-shipping">$0.00</span>
        </div>
        <div class="total-line">
          <span>Tax</span>
          <span id="summary-tax">$0.00</span>
        </div>
        <div class="total-line total">
          <span>Total</span>
          <span id="summary-total">$0.00</span>
        </div>
      </div>
    </aside>
  </div>
</div>

{# Embed customer data for JS #}
<script>
  window.__CHECKOUT_CUSTOMER__ = {{ customer | dump | safe if customer else 'null' }};
</script>
<script src="/js/cart.js"></script>
<script src="/js/checkout.js"></script>

<style>
  .checkout-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }

  .checkout-wrapper {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
  }

  @media (max-width: 768px) {
    .checkout-wrapper {
      grid-template-columns: 1fr;
    }
  }

  .checkout-form {
    display: flex;
    flex-direction: column;
  }

  .checkout-step {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 2rem;
    margin-bottom: 1.5rem;
  }

  .checkout-step.hidden {
    display: none;
  }

  .checkout-step h2 {
    margin-top: 0;
    margin-bottom: 1.5rem;
    font-size: 1.25rem;
  }

  .alert {
    padding: 1rem;
    border-radius: 6px;
    margin-bottom: 1.5rem;
    font-size: 0.95rem;
  }

  .alert-warning {
    background: #fffbeb;
    border: 1px solid #fde68a;
    color: #92400e;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #333;
  }

  .form-group input,
  .form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
    font-family: inherit;
    box-sizing: border-box;
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .form-buttons {
    display: flex;
    gap: 1rem;
    justify-content: space-between;
  }

  .form-buttons .btn {
    flex: 1;
  }

  .order-summary {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 1.5rem;
    height: fit-content;
    position: sticky;
    top: 20px;
  }

  .order-summary h3 {
    margin-top: 0;
    margin-bottom: 1rem;
  }

  .summary-items {
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .summary-item {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    font-size: 0.875rem;
  }

  .summary-totals {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .total-line {
    display: flex;
    justify-content: space-between;
    font-size: 0.875rem;
  }

  .total-line.total {
    border-top: 1px solid #e5e7eb;
    padding-top: 0.75rem;
    font-weight: 600;
    font-size: 1rem;
  }

  .btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 4px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary {
    background: #3b82f6;
    color: white;
  }

  .btn-primary:hover:not(:disabled) {
    background: #2563eb;
  }

  .btn-primary:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  .btn-secondary {
    background: #f3f4f6;
    color: #333;
    border: 1px solid #ddd;
  }

  .btn-secondary:hover {
    background: #e5e7eb;
  }

  .loading {
    text-align: center;
    padding: 1rem;
    color: #666;
  }
</style>
{% endblock %}
