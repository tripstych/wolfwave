{% extends "layouts/base.njk" %}

{% block content %}
<div class="downloads-container">
  <div class="downloads-header">
    <h1>My Downloads</h1>
    <p>Access your purchased digital products</p>
  </div>

  <div id="downloads-content" class="loading">
    Loading your downloads...
  </div>
</div>

<script>
  async function loadDownloads() {
    try {
      const response = await fetch('/api/digital-downloads/my-downloads', {
        credentials: 'include'
      });

      if (!response.ok) {
        if (response.status === 401) {
          window.location.href = '/customer/login';
          return;
        }
        throw new Error('Failed to load downloads');
      }

      const downloads = await response.json();
      const downloadsDiv = document.getElementById('downloads-content');

      if (downloads.length === 0) {
        downloadsDiv.innerHTML = `
          <div class="no-downloads">
            <h3>No Downloads Available</h3>
            <p>You haven't purchased any digital products yet.</p>
            <a href="/shop" class="btn btn-primary">Browse Products</a>
          </div>
        `;
        return;
      }

      downloadsDiv.innerHTML = `
        <div class="downloads-grid">
          ${downloads.map(download => `
            <div class="download-card">
              <div class="download-info">
                <h3>${download.product_title}</h3>
                <p class="download-sku">SKU: ${download.sku}</p>
                <p class="download-date">Purchased: ${new Date(download.order_date).toLocaleDateString()}</p>
                <div class="download-status">
                  <span class="downloads-remaining">${download.download_limit - download.download_count} downloads remaining</span>
                  <span class="expires">Expires: ${new Date(download.expires_at).toLocaleDateString()}</span>
                </div>
              </div>
              <div class="download-actions">
                <a href="${download.download_url}" class="btn btn-primary" download>
                  Download
                </a>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    } catch (err) {
      console.error('Error loading downloads:', err);
      document.getElementById('downloads-content').innerHTML = '<p class="error">Failed to load downloads</p>';
    }
  }

  // Load downloads on page load
  document.addEventListener('DOMContentLoaded', loadDownloads);
</script>

<style>
  .downloads-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem;
  }

  .downloads-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .downloads-header h1 {
    margin: 0 0 0.5rem 0;
    font-size: 2rem;
    color: #1f2937;
  }

  .downloads-header p {
    margin: 0;
    color: #6b7280;
    font-size: 1.1rem;
  }

  .downloads-grid {
    display: grid;
    gap: 1.5rem;
  }

  .download-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .download-info h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.25rem;
    color: #1f2937;
  }

  .download-sku {
    margin: 0 0 0.25rem 0;
    color: #6b7280;
    font-size: 0.875rem;
  }

  .download-date {
    margin: 0 0 1rem 0;
    color: #6b7280;
    font-size: 0.875rem;
  }

  .download-status {
    display: flex;
    gap: 1rem;
    font-size: 0.875rem;
  }

  .downloads-remaining {
    color: #059669;
    font-weight: 500;
  }

  .expires {
    color: #6b7280;
  }

  .download-actions {
    flex-shrink: 0;
  }

  .no-downloads {
    text-align: center;
    padding: 3rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
  }

  .no-downloads h3 {
    margin: 0 0 1rem 0;
    color: #6b7280;
  }

  .no-downloads p {
    margin: 0 0 2rem 0;
    color: #6b7280;
  }

  .loading {
    text-align: center;
    color: #6b7280;
    padding: 2rem;
  }

  .error {
    text-align: center;
    color: #dc2626;
    padding: 2rem;
  }

  @media (max-width: 768px) {
    .download-card {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }

    .download-actions {
      width: 100%;
    }

    .download-actions .btn {
      width: 100%;
      text-align: center;
    }
  }
</style>
{% endblock %}
